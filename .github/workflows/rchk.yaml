name: rchk (Kalibera)

on:
  workflow_dispatch:
  pull_request:
  push:
    branches: [master]
    paths:
      - src/**
      - .github/workflows/rchk.yaml

jobs:
  rchk:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4

      # We need R to build the source package tarball
      - uses: r-lib/actions/setup-r@v2
        with:
          r-version: 'release'

      - name: Build Package
        run: |
          R CMD build --no-manual --no-build-vignettes .
          mkdir packages
          PKG_TAR=$(ls -1 *.tar.gz | head -n 1)
          mv "$PKG_TAR" packages/
          echo "PKG_TAR=$PKG_TAR" >> $GITHUB_ENV

      - name: Create Check Script
        run: |
          cat <<EOF > packages/check.R
          # 0. Setup a local library directory we can write to
          #    (We use /rchk/packages because it is mounted from the host and writable)
          lib_dir <- "/rchk/packages/library"
          dir.create(lib_dir, showWarnings = FALSE)
          .libPaths(c(lib_dir, .libPaths()))

          # 1. Install remotes into our local library
          install.packages("remotes", repos = "https://cloud.r-project.org", lib = lib_dir)

          # 2. Identify the package tarball
          pkg_tar_name <- Sys.getenv("PKG_TAR")
          if (pkg_tar_name == "") {
            pkg_tar_name <- list.files("/rchk/packages", pattern = "\\\\.tar\\\\.gz$", full.names = FALSE)[1]
          }
          pkg_tar_path <- file.path("/rchk/packages", pkg_tar_name)
          
          # Extract source to a temp dir so remotes can read DESCRIPTION
          tmp_dir <- tempfile()
          dir.create(tmp_dir)
          untar(pkg_tar_path, exdir = tmp_dir)
          pkg_src <- list.files(tmp_dir, full.names = TRUE)[1]
          pkg_name <- basename(pkg_src)

          # 3. Install dependencies with --no-clean
          #    This ensures build artifacts (bitcode) for dependencies like hdf5lib persist.
          remotes::install_deps(
            pkg_src, 
            dependencies = c("Depends", "Imports", "LinkingTo"), 
            repos = "https://cloud.r-project.org",
            lib = lib_dir,
            INSTALL_opts = c("--no-clean", "--no-byte-compile")
          )

          # 4. Install the target package libs for rchk analysis
          #    (The internal script handles its own install location)
          source("/rchk/scripts/utils.r")
          install_package_libs(pkg_tar_path, target = "/rchk/packages/libsonly")

          # 5. Run the actual check
          cmd <- paste("/rchk/scripts/check_package.sh", pkg_name)
          status <- system(cmd)

          if (status != 0) quit(status = status)
          EOF

      - name: Run rchk
        run: |
          docker pull kalibera/rchk:latest
          docker run --rm \
            -v "$PWD/packages:/rchk/packages" \
            -e PKG_TAR="${{ env.PKG_TAR }}" \
            kalibera/rchk:latest \
            R -f /rchk/packages/check.R

      - name: Verify Results
        shell: Rscript {0}
        run: |
          # The rchk tool writes report files to:
          # packages/libsonly/<pkg>/libs/<pkg>.so.{maacheck,bcheck}
          
          pkg           <- read.dcf("DESCRIPTION")[,"Package"]
          libs_dir      <- file.path("packages", "libsonly", pkg, "libs")
          maacheck_file <- file.path(libs_dir, paste0(pkg, ".so.maacheck"))
          bcheck_file   <- file.path(libs_dir, paste0(pkg, ".so.bcheck"))
          
          stopifnot(file.exists(maacheck_file))
          stopifnot(file.exists(bcheck_file))

          # Ignore "too many states" warnings from bcheck
          # and the final "Analyzed 104 functions" summary line
          errors <- readLines(bcheck_file)
          errors <- errors[!grepl("too many states", errors)]
          errors <- errors[!grepl("^Analyzed [0-9]+ functions", errors)]

          # Anything in maacheck log is a failure
          errors <- c(errors, readLines(maacheck_file))
          
          # Remove empty lines
          errors <- errors[nzchar(errors)]
          
          if (length(errors) > 0) {
            stop("rchk failed! Errors detected in analysis logs:\n", paste(errors, collapse = "\n"))
          } else {
            cat("\nSUCCESS: No memory protection errors found by rchk.\n")
          }
